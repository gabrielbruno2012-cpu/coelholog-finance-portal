<html>
<head>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<script>
// Proteção correta
const uStr = localStorage.getItem("usuario");
let u = null;
try { u = uStr ? JSON.parse(uStr) : null; } catch(e){ u = null; }

if (!u) {
  window.location.href = "/";
} else if (u.role !== "financeiro" && u.role !== "admin") {
  window.location.href = "/colaborador/dashboard.html";
}
</script>

<div id="sidebar"></div>

<div class="main">

    <div class="header-right">
        <img src="/img/logo.png" class="toplogo">
        <button class="btn" onclick="localStorage.clear();location='/'">Logout</button>
    </div>

    <h1>Alterar Recebíveis</h1>

    <table class="table" id="lista"></table>
</div>

<script>
// Carregar sidebar
fetch('/admin/sidebar_admin.html')
    .then(r => r.text())
    .then(h => sidebar.innerHTML = h);

// Formatador
function fmtValor(n) {
    return Number(n || 0).toLocaleString("pt-BR", { minimumFractionDigits: 2 });
}

async function load() {
    let dados = await fetch('/api/recebiveis').then(r => r.json());

    let html = `
        <tr>
            <th>ID</th>
            <th>Usuário</th>
            <th>Data</th>
            <th>Valor</th>
            <th>Tipo</th>
            <th>Status</th>
            <th>Ação</th>
        </tr>
    `;

    dados.forEach(e => {
        html += `
            <tr id="row${e.id}">

                <td>${e.id}</td>

                <td style="color:#409cff; font-weight:600">
                    ${e.nome}
                </td>

                <td>
                    <input type="date" class="input" id="dt${e.id}" value="${e.data}">
                </td>

                <td>
                    <input type="number" step="0.01" class="input" id="vl${e.id}" value="${e.valor}">
                </td>

                <td>
                    <input type="text" class="input" id="tp${e.id}" value="${e.tipo}">
                </td>

                <td>
                    <select class="input" id="st${e.id}">
                        <option ${e.status=="Pendente"?"selected":""}>Pendente</option>
                        <option ${e.status=="Pago"?"selected":""}>Pago</option>
                    </select>
                </td>

                <td>
                    <button class="btn" onclick="save(${e.id})">Salvar</button>
                </td>
            </tr>
        `;
    });

    lista.innerHTML = html;
}

async function save(id) {

    let data = document.getElementById("dt"+id).value;
    let valor = document.getElementById("vl"+id).value;
    let tipo = document.getElementById("tp"+id).value;
    let status = document.getElementById("st"+id).value;

    const res = await fetch("/api/recebiveis/" + id, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data, valor, tipo, status })
    });

    if (!res.ok) {
        alert("Erro ao atualizar!");
        return;
    }

    alert("Recebível atualizado com sucesso!");
}

load();
</script>

<style>
.toplogo {
    height: 38px;
    margin-right: 20px;
}
</style>

</body>
</html>
